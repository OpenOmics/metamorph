FROM condaforge/miniforge3:latest
RUN apt-get update; apt-get install -y -qq curl vim dos2unix
RUN mamba create -y -n metawrap-env
RUN conda config --add channels defaults; conda config --add channels conda-forge; \
    conda config --add channels bioconda;conda config --add channels ursky
# RUN mamba install -y -n metawrap-env biopython blas=2.5 blast=2.6.0 bmtagger bowtie2 bwa checkm-genome \
#    fastqc kraken=1.1 kraken=2.0 krona=2.7 matplotlib maxbin2 megahit metabat2 pandas \
#    prokka quast r-ggplot2 r-recommended salmon samtools=1.9 seaborn spades trim-galore
RUN mamba install -y --only-deps -c ursky -n metawrap-env metawrap-mg==1.3.2
RUN cd /home; git clone https://github.com/bxlab/metaWRAP.git; chmod -R 777 metaWRAP
RUN echo ". ${CONDA_DIR}/etc/profile.d/conda.sh && conda activate metawrap-env" >> /etc/skel/.bashrc && \
    echo ". ${CONDA_DIR}/etc/profile.d/conda.sh && conda activate metawrap-env" >> ~/.bashrc
ENV PATH="/home/metaWRAP/bin:$PATH"
COPY docker/metawrap/config-metawrap /home/metaWRAP/bin/config-metawrap
RUN dos2unix /home/metaWRAP/bin/config-metawrap
RUN chmod u+x /home/metaWRAP/bin/config-metawrap
RUN mamba run -n metawrap-env pip3 install drep
ENV BASH_ENV=/etc/skel/.bashrc
ENTRYPOINT ["tini", "--", "/bin/bash", "--rcfile", "/etc/skel/.bashrc"]
